head	1.11;
access;
symbols
	P20050924_InfoVis:1.11
	Preliminary_Design:1.9
	P200501_Prototype:1.9;
locks; strict;
comment	@# @;


1.11
date	2005.09.24.18.57.31;	author jheer;	state Exp;
branches;
next	1.10;

1.10
date	2005.09.24.18.40.28;	author jheer;	state Exp;
branches;
next	1.9;

1.9
date	2005.01.19.23.28.10;	author jheer;	state Exp;
branches;
next	1.8;

1.8
date	2004.11.10.01.53.05;	author jheer;	state Exp;
branches;
next	1.7;

1.7
date	2004.11.08.04.12.34;	author jheer;	state Exp;
branches;
next	1.6;

1.6
date	2004.04.20.04.18.43;	author jheer;	state Exp;
branches;
next	1.5;

1.5
date	2004.04.20.03.54.17;	author jheer;	state Exp;
branches;
next	1.4;

1.4
date	2004.04.19.03.34.07;	author jheer;	state Exp;
branches;
next	1.3;

1.3
date	2004.04.16.06.59.01;	author jheer;	state Exp;
branches;
next	1.2;

1.2
date	2004.04.15.01.51.01;	author jheer;	state Exp;
branches;
next	1.1;

1.1
date	2004.04.15.00.36.40;	author jheer;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Added a centerDisplay() call on graph load.
@
text
@package vizster;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.geom.Point2D;
import java.awt.geom.Rectangle2D;
import java.sql.SQLException;
import java.util.Iterator;
import java.util.TimerTask;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;

import prefusex.community.CommunitySet;
import prefusex.lucene.TextSearchFocusSet;
import prefusex.lucene.TextSearchPanel;
import vizster.action.AuraFilter;
import vizster.action.CommunityConstructor;
import vizster.action.CommunityEdgeLabeler;
import vizster.action.CommunityFilter;
import vizster.action.CommunityLayout;
import vizster.action.HighlightAction;
import vizster.action.HighlightSettingAction;
import vizster.action.InvertToggleAction;
import vizster.action.VizsterBrowsingColorFunction;
import vizster.action.VizsterFontFunction;
import vizster.action.VizsterLayout;
import vizster.action.VizsterSizeFunction;
import vizster.action.VizsterXRayColorFunction;
import vizster.action.linkage.LinkageFilter;
import vizster.action.linkage.ReleaseFixedAction;
import vizster.action.linkage.VizsterCircleLayout;
import vizster.controls.ExpansionControl;
import vizster.controls.FocusRequester;
import vizster.controls.HighlightControl;
import vizster.controls.HighlightHoldControl;
import vizster.controls.LinkageControl;
import vizster.controls.ZoomStepControl;
import vizster.render.VizsterRendererFactory;
import vizster.ui.CommunityPanel;
import vizster.ui.Legend;
import vizster.ui.ProfilePanel;
import vizster.ui.VizsterMenuBar;
import edu.berkeley.guir.prefuse.Display;
import edu.berkeley.guir.prefuse.FocusManager;
import edu.berkeley.guir.prefuse.ItemRegistry;
import edu.berkeley.guir.prefuse.NodeItem;
import edu.berkeley.guir.prefuse.action.AbstractAction;
import edu.berkeley.guir.prefuse.action.Action;
import edu.berkeley.guir.prefuse.action.ActionMap;
import edu.berkeley.guir.prefuse.action.ActionSwitch;
import edu.berkeley.guir.prefuse.action.RepaintAction;
import edu.berkeley.guir.prefuse.action.animate.LocationAnimator;
import edu.berkeley.guir.prefuse.action.animate.PolarLocationAnimator;
import edu.berkeley.guir.prefuse.action.animate.SizeAnimator;
import edu.berkeley.guir.prefuse.action.assignment.Layout;
import edu.berkeley.guir.prefuse.action.filter.FisheyeGraphFilter;
import edu.berkeley.guir.prefuse.action.filter.GarbageCollector;
import edu.berkeley.guir.prefuse.activity.ActionList;
import edu.berkeley.guir.prefuse.activity.SlowInSlowOutPacer;
import edu.berkeley.guir.prefuse.event.FocusEvent;
import edu.berkeley.guir.prefuse.event.FocusListener;
import edu.berkeley.guir.prefuse.focus.DefaultFocusSet;
import edu.berkeley.guir.prefuse.focus.FocusSet;
import edu.berkeley.guir.prefuse.graph.DefaultGraph;
import edu.berkeley.guir.prefuse.graph.Entity;
import edu.berkeley.guir.prefuse.graph.Graph;
import edu.berkeley.guir.prefuse.graph.GraphLib;
import edu.berkeley.guir.prefuse.graph.Node;
import edu.berkeley.guir.prefuse.graph.event.GraphLoaderListener;
import edu.berkeley.guir.prefuse.graph.external.GraphLoader;
import edu.berkeley.guir.prefuse.util.display.DisplayLib;
import edu.berkeley.guir.prefusex.controls.DragControl;
import edu.berkeley.guir.prefusex.controls.FocusControl;
import edu.berkeley.guir.prefusex.controls.PanControl;
import edu.berkeley.guir.prefusex.controls.ZoomControl;
import edu.berkeley.guir.prefusex.force.ForceSimulator;
import edu.berkeley.guir.prefusex.layout.ForceDirectedLayout;
import edu.berkeley.guir.prefusex.layout.FruchtermanReingoldLayout;

/**
 * An application for visual exploration of the friendster social networking
 * service.
 *
 * @@version 1.0
 * @@author <a href="http://jheer.org">Jeffrey Heer</a> vizster(AT)jheer.org
 */
public class Vizster extends JFrame {

    // default starting friendster user id
    public static final String DEFAULT_START_UID = "186297";
    public static final String ID_FIELD = "uid";
    
    // keys for additional focus sets
    public static final String CLICK_KEY  = "clicked";
    public static final String MOUSE_KEY  = "moused";
    public static final String SEARCH_KEY = "search";
    public static final String HIGHLIGHT_KEY = "highlight";
    public static final String COMMUNITY_KEY = "community";
    
    // names of additional item classes
    public static final String AURA_CLASS = "aura";
    
    // modes the interface can be in
    public static final int BROWSE_MODE = 0;
    public static final int COMPARE_MODE = 1;
    
    // prefuse architecture components
    private ItemRegistry registry;
    private ActionList redraw, forces, altForces, altAnimate, filter, magnify;
    private ActionList aura, community, highlight, linkLayout, unfix, border;
    private VizsterDBLoader loader;
    private boolean useDatabase, xrayMode = false;
    private VizsterRendererFactory renderers;
    private ActionMap actionMap;
    
    // control if layout remains animated
    private boolean animate = true;
    
    // ui components
    private VizsterDisplay display;
    private ProfilePanel profilePanel;
    private JPanel container;
    private TextSearchPanel searchPanel;
    private CommunityPanel communityPanel;
    
    // number of login attempts before application exits
    private int loginRetries = 5;
    
    /**
     * Launches the Vizster application
     * @@param argv this app takes one optional argument - a friendster user id
     *  to show upon launch.
     */
    public static void main(String[] argv) {
        VizsterLib.setLookAndFeel();
        //String startUID = argv.length > 0 ? argv[0] : DEFAULT_START_UID;
        String startUID = DEFAULT_START_UID;
        String file = argv.length > 0 ? argv[0] : null;
        new Vizster(startUID, file);
    } //
    
    /**
     * Construct a new Vizster application instance.
     */
    public Vizster() {
        this(DEFAULT_START_UID, null);
    } //
    
    /**
     * Construct a new Vizster application instance.
     * @@param startUID the user id to show first
     */
    public Vizster(String startUID) {
        this(startUID, null);
    } //
    
    /**
     * Construct a new Vizster application instance.
     * @@param startUID the user id to show first
     * @@param datafile the data file to use, if null, 
     *   a connection dialog for a database will be provided 
     */
    public Vizster(String startUID, String datafile) {
        super("Vizster");
        
        // determine input method
        this.useDatabase = (datafile==null);
        
        // create the registry
        registry = new ItemRegistry(new DefaultGraph());
        registry.setItemComparator(new VizsterItemComparator());
        registry.addItemClass(AURA_CLASS, DecoratorItem.class);
        
        // initialize focus handling
        // -We already get a default focus set, use it for double-clicked nodes
        // -Add another set for nodes that are single-clicked, to show profiles
        // -Add another set for nodes moused-over
        // -Add another set for controlling highlight status
        // -Add another set for sets of automatically-determined communities
        // -Add another set for keyword search hits
        FocusManager fmanager = registry.getFocusManager();
        fmanager.putFocusSet(CLICK_KEY, new DefaultFocusSet());
        fmanager.putFocusSet(MOUSE_KEY, new DefaultFocusSet());
        fmanager.putFocusSet(HIGHLIGHT_KEY, new DefaultFocusSet());
        fmanager.putFocusSet(COMMUNITY_KEY, new CommunitySet(true));
        final TextSearchFocusSet searchSet = new TextSearchFocusSet();
        fmanager.putFocusSet(SEARCH_KEY, searchSet);
        
        if ( useDatabase ) {
	        // create a new loader to talk to the database if needed
	        loader = new VizsterDBLoader(registry, VizsterDBLoader.ALL_COLUMNS);
	        // register update listener with graph loader
	        loader.addGraphLoaderListener(new GraphLoaderListener() {
	            public void entityLoaded(GraphLoader loader, Entity e) {
	                filter.runNow();
	            } //
	            public void entityUnloaded(GraphLoader loader, Entity e) {
	                filter.runNow();
	            } //
	        });
        }
        
        // initialize user interface components
        // set up the primary display
        display = new VizsterDisplay(this);
        display.setSize(700,650);
        // create the panel which shows friendster profile data
        profilePanel = new ProfilePanel(this);
        // create the search panel
        searchPanel = new TextSearchPanel(VizsterDBLoader.ALL_COLUMNS,
                registry, searchSet, fmanager.getFocusSet(CLICK_KEY));
        // create the community explorer panel
        communityPanel = new CommunityPanel(this);
        
        // initialize the prefuse renderers and action lists
        initPrefuse();
        
        // initialize the display's control listeners
        display.addControlListener(new ExpansionControl(2));
        display.addControlListener(new FocusControl(1, CLICK_KEY));
        display.addControlListener(new HighlightControl(highlight, MOUSE_KEY));
        display.addControlListener(new HighlightHoldControl(highlight,
                HIGHLIGHT_KEY, this, HighlightHoldControl.CLICK_AND_HOLD_MODE));
        //display.addControlListener(new HighlightFreezeControl(highlight, HIGHLIGHT_KEY));
        display.addControlListener(new LinkageControl(this));
        display.addControlListener(new DragControl(redraw, true));
        display.addControlListener(new PanControl(true));
        //display.addControlListener(new MagnifyControl(this, MagnifyControl.CLICK_AND_HOLD_MODE));
        display.addMouseListener(new FocusRequester());
        
        // add a zoom control that works everywhere
        ZoomControl zc = new ZoomControl(true);
        zc.setMaxScale(10.0);
        zc.setMinScale(0.1);
        display.addMouseListener(zc);
        display.addMouseMotionListener(zc);
        
        // add click-only zoom controls
        ZoomStepControl zsc = new ZoomStepControl(this);
        display.addMouseListener(zsc);
        display.addMouseMotionListener(zsc);
        
        // set up the JFrame
        setJMenuBar(new VizsterMenuBar(this));
        initUI(); pack();
        setVisible(true);
        
        // wait until graphics are available
        while ( display.getGraphics() == null );
        
        // load the network data
        loadGraph(datafile, startUID);
    } //
    
    public void loadGraph(String datafile, String startUID) {
        // stop any running actions
        forces.cancel();
        
        // alter settings as needed
        useDatabase = (datafile==null);
        
        // load graph
        try {
	        Graph g = null;
	        if ( useDatabase ) {
	            g = new DefaultGraph();
	        } else {
	            g = VizsterLib.loadGraph(datafile);
	        }
	        registry.setGraph(g);
        } catch ( Exception e ) {
            e.printStackTrace();
            VizsterLib.defaultError(this, "Couldn't load input graph.");
            return;
        }
        
        // attempt to login to database if necessary
        if ( useDatabase && !(loader.isConnected() ||
                VizsterLib.authenticate(this, loginRetries)) ) {
            //System.exit(0); // user canceled login so exit
            return;
        }
        
        // retrieve the initial profile and set as focus
        Node r = getInitialNode(startUID);
        registry.getDefaultFocusSet().set(r);
        registry.getFocusManager().getFocusSet(CLICK_KEY).set(r);
        centerDisplay();
        
        filter.runNow();
        if ( animate ) {
            forces.runNow();
        } else {
            runStaticLayout();
        }
    } //
    
    private Node getInitialNode(String uid) {
        Node r = null;
        if ( useDatabase ) {
	        try {
	            r = loader.getProfileNode(uid);
	        } catch ( SQLException e ) {
	            e.printStackTrace();
	            VizsterLib.profileLoadError(this, uid);
	            System.exit(1);
	        }
	        // add initial node to the graph
	        registry.getGraph().addNode(r);
        } else {
            if ( uid == null ) {
                r = GraphLib.getMostConnectedNodes(registry.getGraph())[0]; 
            } else {
                Node[] matches = GraphLib.search(registry.getGraph(), ID_FIELD, uid);
                if ( matches.length > 0 ) {
                    r = matches[0];
                } else {
                    r = GraphLib.getMostConnectedNodes(registry.getGraph())[0];
                }
            }
        }
        return r;
    } //
    
    private void initUI() {
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        
        // recenter the display upon resizing
        display.addComponentListener(new ComponentAdapter() {
            public void componentResized(ComponentEvent e) {
                centerDisplay();
            } //
        });
        
        JScrollPane scroller = new JScrollPane(profilePanel);
        scroller.setHorizontalScrollBarPolicy(
                JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        scroller.setVerticalScrollBarPolicy(
                JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
        Dimension pd = profilePanel.getPreferredSize();
        scroller.setPreferredSize(new Dimension(300,pd.height));
        
        searchPanel.setBorder(BorderFactory.createEmptyBorder(4,4,4,4));
        communityPanel.setBorder(BorderFactory.createEmptyBorder(4,4,4,4));
        
        container = new JPanel();
        container.setLayout(new BoxLayout(container, BoxLayout.X_AXIS));
        container.add(communityPanel);
        container.add(Box.createHorizontalGlue());
        container.add(searchPanel);
        container.setBackground(Color.WHITE);
        
        JPanel main = new JPanel(new BorderLayout());
        main.add(display, BorderLayout.CENTER);
        main.add(container, BorderLayout.SOUTH);
        
        JSplitPane split = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT,
                false, main, scroller);
        split.setDividerSize(10);
        split.setResizeWeight(1.0);
        split.setOneTouchExpandable(true);
        
        getContentPane().add(split);
    } //
    
    public void centerDisplay() {
        Point2D centroid = DisplayLib.getCentroid(registry,
                registry.getDefaultFocusSet().iterator());
        centerDisplay(centroid);
    } //
    
    public void centerDisplay(Point2D p) {
        display.animatePanToAbs(p, 2000);
    } //
    
    public void resetDisplay() {
        Rectangle2D b = DisplayLib.getNodeBounds(registry,50);
        DisplayLib.fitViewToBounds(display, b);
    } //
    
    public void unzoom() {
        int x = display.getWidth()/2;
        int y = display.getHeight()/2;
        display.animateZoom(new Point2D.Float(x,y),0,2000);
    } //
    
    // ========================================================================
    // == PREFUSE INITIALIZATION ==============================================
    
    private void initPrefuse() {
        // initialize action map
        actionMap = new ActionMap();
        
        // initialize renderers
        renderers = new VizsterRendererFactory(this);
        registry.setRendererFactory(renderers);
        
        // ====================================================================
        // == set up actions ==================================================
        
        // filters
        FisheyeGraphFilter feyeFilter = new FisheyeGraphFilter(-1,true,false);
        AuraFilter         auraFilter = new AuraFilter();
        GarbageCollector   gcFilter   = new GarbageCollector(new String[]
          {ItemRegistry.DEFAULT_NODE_CLASS, ItemRegistry.DEFAULT_EDGE_CLASS});
        feyeFilter.setEdgesInteractive(false);
        
        // layout routines
        Layout frLayout = new FruchtermanReingoldLayout(400);
        Layout fdLayout = new VizsterLayout();
        
        // colors and highlights
        VizsterBrowsingColorFunction vcolor = new VizsterBrowsingColorFunction();
        VizsterXRayColorFunction xcolor = new VizsterXRayColorFunction();
        HighlightAction         hilite = new HighlightAction(2);
        
        // community actions
        CommunityFilter      commFilter    = new CommunityFilter(COMMUNITY_KEY);
        CommunityEdgeLabeler commLabeler   = new CommunityEdgeLabeler(COMMUNITY_KEY);
        CommunityConstructor commConstruct = new CommunityConstructor(COMMUNITY_KEY, vcolor);
        
        // initialize basic recoloring-drawing action lists
        ActionSwitch colorSwitch = new ActionSwitch(
                new Action[] {vcolor, xcolor}, 0);
        
        // ====================================================================
        // == set up actions lists ============================================
        
        // initialize basic redraw action
        redraw = new ActionList(registry);
        redraw.add(new CommunityLayout(COMMUNITY_KEY));
        redraw.add(colorSwitch);
        redraw.add(actionMap.put("fonts", new VizsterFontFunction()));
        redraw.add(new RepaintAction());
        
        // initialize lists for linkage mode
        ActionList linkageList = new ActionList(registry);
        linkageList.add(new HighlightSettingAction(-1));
        linkageList.add(new LinkageFilter(false));
        
        // initialize list for community filtering
        community = new ActionList(registry);
        community.add(commConstruct);
        community.add(commFilter);
        community.add(commLabeler);
        
        // experimental link view layout / animation
        linkLayout = new ActionList(registry);
        linkLayout.add(new VizsterCircleLayout());
        
        ActionList linkAnimate = new ActionList(registry,800);
        linkAnimate.setPacingFunction(new SlowInSlowOutPacer());
        linkAnimate.add(new LocationAnimator());
        linkAnimate.alwaysRunAfter(linkLayout);
        
        unfix = new ActionList(registry);
        unfix.add(new ReleaseFixedAction());
        
        ActionList unfixAnimate = new ActionList(registry,800);
        unfixAnimate.add(new LocationAnimator());
        unfixAnimate.alwaysRunAfter(unfix);
        // -----
        
        // initialize the filter action list
        filter = new ActionList(registry);
        filter.add(feyeFilter);
        filter.add(linkageList);
        filter.add(gcFilter);
        filter.add(commFilter);
        filter.add(commLabeler);
        filter.add(auraFilter);
        filter.add(colorSwitch);
        
        // initialize action list for filtering search auras
        aura = new ActionList(registry);
        aura.add(auraFilter);
        aura.add(hilite);
        aura.add(colorSwitch);
        
        // initialize action list for highlighting
        highlight = new ActionList(registry);
        highlight.add(hilite);
        
        // intialize lists for magnification
        magnify = new ActionList(registry);
        magnify.add(actionMap.put("size", new VizsterSizeFunction()));
        
        ActionList magnifyAnimate = new ActionList(registry, 1000);
        magnifyAnimate.add(new SizeAnimator());
        magnifyAnimate.alwaysRunAfter(magnify);
        // -----
        
        // initialize lists for outline flashing
        border = new ActionList(registry,350);
        border.add(new InvertToggleAction());
        
        // initilaize the layout, including communities
        forces = new ActionList(registry,-1,20);
        forces.add(new AbstractAction() {
            public void run(ItemRegistry registry, double frac) {                
                Iterator iter = registry.getDefaultFocusSet().iterator();
                while ( iter.hasNext() ) {
                    Entity e = (Entity)iter.next();
                    if (e instanceof Node) {
                        NodeItem item = registry.getNodeItem((Node)e);
                        if ( item != null ) item.setFixed(true);
                    }
                }
            } //
        });
        forces.add(fdLayout);
        forces.add(redraw);
        
        // initialize action list for an alternate, static layout
        altForces = new ActionList(registry, 0);
        altForces.add(frLayout);
        altForces.add(colorSwitch);
        
        // animator between static configurations
        altAnimate = new ActionList(registry, 2000, 20);
        altAnimate.setPacingFunction(new SlowInSlowOutPacer());
        altAnimate.add(new PolarLocationAnimator());
        altAnimate.add(redraw);
        
        // put actions into action map
        actionMap.put("filter", feyeFilter);
        actionMap.put("linkSwitch", linkageList);
        actionMap.put("browseColors", vcolor);
        actionMap.put("compareColors", xcolor);
        actionMap.put("colorSwitch", colorSwitch);
        actionMap.put("dynamicForces", fdLayout);
        actionMap.put("staticForces", frLayout);
        actionMap.put("highlight", hilite);
        actionMap.put("commConstruct", commConstruct);
        
        // ====================================================================
        // == initialize focus listeners ======================================
        
        final FocusSet defaultSet = registry.getDefaultFocusSet();
        defaultSet.addFocusListener(new FocusListener() {
            public void focusChanged(FocusEvent e) {
                // unfix previous center items
                Entity[] removed = e.getRemovedFoci();
                for ( int i=0; i < removed.length; i++) {
                    NodeItem n = registry.getNodeItem((Node)removed[i]);
                    if ( n != null ) { n.setFixed(false); n.setWasFixed(false); }
                }
                
                // set current focus as referrer for newly visible nodes
                Node added = (Node)e.getFirstAdded();
                NodeItem addedItem = registry.getNodeItem(added);
                if ( addedItem != null ) {
                    setReferrer(addedItem);
                }

                setLinkageMode(false);
                filter.runNow(); // refilter
                setAnimate(true);
                
                // load neighbors from database as necessary
                if ( useDatabase && added != null) {
                    loader.loadNetwork(added,2);
                }
                
                if ( addedItem != null ) {
                    centerDisplay(addedItem.getLocation()); // center display on the new focus
                }
                    
                TimerTask task = new TimerTask() {
                    public void run() {
                        searchPanel.searchUpdate();
                    } //
                };
                VizsterLib.getTimer().schedule(task,500);
            } //
        });
        
        FocusManager fmanager = registry.getFocusManager();
        FocusSet clickedSet = fmanager.getFocusSet(CLICK_KEY);
        clickedSet.addFocusListener(new FocusListener() {
            public void focusChanged(FocusEvent e) {
                // update profile panel to show new focus
                Node f = (Node)e.getFirstAdded();
                if ( f != null )
                    profilePanel.updatePanel(f);
                NodeItem item = registry.getNodeItem(f);
                if ( item != null )
                    setReferrer(item);
            } //
        });
        
        FocusSet searcher = fmanager.getFocusSet(SEARCH_KEY);
        searcher.addFocusListener(new FocusListener() {
            public void focusChanged(FocusEvent e) {
                if (e.getAddedFoci().length>0 || e.getRemovedFoci().length>0)
                    aura.runNow();
            } //
        });
    } //
    
    // ========================================================================
    // == ACCESSOR METHODS ====================================================
    
    public int getLoginRetries() {
        return loginRetries;
    } //
    
    public ItemRegistry getItemRegistry() {
        return registry;
    } //
    
    public Display getDisplay() {
        return display;
    } //
    
    public VizsterDBLoader getLoader() {
        return loader;
    } //
    
    public ForceSimulator getForceSimulator() {
        return ((VizsterLayout)actionMap.get("dynamicForces")).getForceSimulator();
    } //
    
    public void setMode(int mode) {
        if ( mode != BROWSE_MODE && mode != COMPARE_MODE )
            return;
        boolean b = (mode == BROWSE_MODE);
        xrayMode = !b;
        Color bg = b ? Color.WHITE : Color.BLACK;
        Color fg = b ? Color.BLACK : Color.WHITE;
        this.setBackground(bg);
        this.setForeground(fg);
        display.setBackground(bg);
        display.setForeground(fg);
        searchPanel.setBackground(bg);
        searchPanel.setForeground(fg);
        communityPanel.setBackground(bg);
        communityPanel.setForeground(fg);
        container.setBackground(bg);
        container.setForeground(fg);
        ActionSwitch as = (ActionSwitch)actionMap.get("colorSwitch");
        as.setSwitchValue(b?0:1);
        
        if ( !b ) {
            VizsterXRayColorFunction cf = (VizsterXRayColorFunction)
            	actionMap.get("compareColors");
            Legend l = new Legend(cf.getLabels(), cf.getColorMap());
            display.setLegend(l);
        } else {
            display.setLegend(null);
        }
    } //
    
    public boolean isXRayMode() {
        return xrayMode;
    } //
    
    public VizsterXRayColorFunction getComparisonColorFunction() {
        return (VizsterXRayColorFunction)actionMap.get("compareColors");
    } //
    
    public VizsterBrowsingColorFunction getBrowsingColorFunction() {
        return (VizsterBrowsingColorFunction)actionMap.get("browseColors");
    } //
    
    public boolean isAnimate() {
        return animate;
    } //
    
    public void redraw() {
        //redraw.runNow();
    } //
    
    public void setAnimate(boolean b) {
        if ( b ) {
            forces.runNow();
        } else {
            forces.cancel();
        }
        animate = b;
    } //
    
    public void runStaticLayout() {
        altAnimate.runAfter(altForces);
        altForces.runNow();
    } //
    
    public void runFilter() {
        filter.runNow();
    } //
    
    public void constructCommunities(int idx) {
    	((CommunityConstructor)actionMap.get("commConstruct")).setIndex(idx);
        community.runNow();
    } //
    
    public void setReferrer(NodeItem item) {
        ((ForceDirectedLayout)actionMap.get("dynamicForces"))
    		.setReferrer(item);
    } //
    
    public void setMagnify(boolean state) {
        VizsterSizeFunction sizeFunc = (VizsterSizeFunction)actionMap.get("size");
        sizeFunc.setMagnify(state);
        magnify.runNow();
        if ( state )
            border.runNow();
    } //
    
    public void setLinkageMode(boolean state) {
        Action linkage = (Action)actionMap.get("linkSwitch");
        boolean enabled = linkage.isEnabled();
        if ( state != enabled ) {
            highlight.setEnabled(!state);
            linkage.setEnabled(state);
            filter.runNow();
            if ( !state ) {
                highlight.runNow();
            }
        }
    } //
    
    public void search(String query) {
        searchPanel.setQuery(query);
    } //
    
    public void setShowImages(boolean s) {
        ((VizsterRendererFactory)registry.getRendererFactory()).setDrawImages(s);
    } //
    
    public void setLinkHighlighting(boolean s) {
        ((HighlightAction)actionMap.get("highlight")).setShowEdges(s);
    } //
    
    public void setPassHighlightTroughFocus(boolean s) {
        ((HighlightAction)actionMap.get("highlight")).setSkipFoci(s);
    } //
    
    public void setHighlightHops(int h) {
        ((HighlightAction)actionMap.get("highlight")).setHops(h);
    } //
    
} // end of class Vizster
@


1.10
log
@Update to new version!!
@
text
@d297 1
d574 1
a574 1
                if ( addedItem != null )
d576 2
a577 1
                
@


1.9
log
@Added search panel update, new menu item
@
text
@d9 1
d12 1
d15 2
d22 25
a46 2
import vizster.color.BrowsingColorFunction;
import vizster.color.ComparisonColorFunction;
d48 4
a51 2
import vizster.util.ProfilePanel;
import vizster.util.VizsterMenuBar;
a52 1
import edu.berkeley.guir.prefuse.EdgeItem;
d61 1
d63 1
d66 1
a72 1
import edu.berkeley.guir.prefuse.focus.PrefixSearchFocusSet;
d80 1
a80 1
import edu.berkeley.guir.prefuse.util.PrefixSearchPanel;
a82 1
import edu.berkeley.guir.prefusex.controls.NeighborHighlightControl;
a84 1
import edu.berkeley.guir.prefusex.force.DragForce;
a85 2
import edu.berkeley.guir.prefusex.force.NBodyForce;
import edu.berkeley.guir.prefusex.force.SpringForce;
d106 5
d118 2
a119 1
    private ActionList redraw, forces, altForces, altAnimate, filter;
d121 1
a121 2
    private boolean useDatabase;
    private String datafile;
a122 1
    private ForceSimulator fsim;
d129 5
a133 3
    private Display display;
    private ProfilePanel profile;
    private PrefixSearchPanel searcher;
a175 1
        this.datafile = datafile;
d180 2
d186 3
a188 1
        // -Add another set for nodes moused-over, providing highlights
d193 3
a195 1
        final PrefixSearchFocusSet searchSet = new PrefixSearchFocusSet();
d204 1
a204 1
	                filter.runNow(); forces.runNow();
d207 1
a207 1
	                filter.runNow(); forces.runNow();
d214 1
a214 1
        display = new VizsterDisplay(registry);
d217 1
a217 1
        profile = new ProfilePanel(this);
d219 1
a219 1
        searcher = new PrefixSearchPanel(VizsterDBLoader.ALL_COLUMNS,
d221 2
d228 1
a228 1
        display.addControlListener(new FocusControl(2));
d230 6
a235 3
        display.addControlListener(new FocusControl(0, MOUSE_KEY));
        display.addControlListener(new NeighborHighlightControl(redraw));
        display.addControlListener(new DragControl(true, true));
d237 2
d242 2
d247 5
d287 2
a288 1
        if ( useDatabase && !VizsterLib.authenticate(this, loginRetries) ) {
d343 1
a343 1
        JScrollPane scroller = new JScrollPane(profile);
d348 1
a348 1
        Dimension pd = profile.getPreferredSize();
d351 9
a359 1
        searcher.setBorder(BorderFactory.createEmptyBorder(4,4,4,4));
d363 1
a363 1
        main.add(searcher, BorderLayout.SOUTH);
d375 12
a386 10
        Iterator iter = registry.getDefaultFocusSet().iterator();
        if ( iter.hasNext() ) {
            Node f = (Node)iter.next();
            NodeItem n = registry.getNodeItem(f);
            if ( n == null ) {
                n = registry.getNodeItem(f,true);
                filter.runNow();
            }
            display.animatePanToAbs(n.getLocation(), 2000);
        }
d395 3
d399 3
d403 1
a403 2
        renderers = new VizsterRendererFactory(display);
        renderers.setBrowseMode(true);
d406 9
a414 11
        // initialize the force simulator
        fsim = new ForceSimulator();
        fsim.addForce(new NBodyForce(-1.5f, -1f, 0.9f));
        final SpringForce springF = new SpringForce(2E-5f, 150f);
        fsim.addForce(springF);
        fsim.addForce(new DragForce(-0.005f));
        
        // set up actions
        FisheyeGraphFilter      feyeFilter = new FisheyeGraphFilter(-1);
        BrowsingColorFunction   bcolorFunc = new BrowsingColorFunction();
        ComparisonColorFunction ccolorFunc = new ComparisonColorFunction();
d416 1
d418 11
a428 23
        Layout fdLayout = new ForceDirectedLayout(fsim, false, false) {
            private float normal = 2E-5f;
            private float slack1 = 2E-6f;
            private float slack2 = 2E-7f;
            protected float getSpringLength(EdgeItem e) {
                NodeItem n1 = (NodeItem)e.getFirstNode();
                NodeItem n2 = (NodeItem)e.getSecondNode();
                int minE = Math.min(n1.getEdgeCount(),n2.getEdgeCount());
                double doi = Math.max(n1.getDOI(), n2.getDOI());
                return ( minE == 1 ? 75.f : (doi==0? 200.f : 100.f));
            } //
            protected float getSpringCoefficient(EdgeItem e) {
                NodeItem n1 = (NodeItem)e.getFirstNode();
                NodeItem n2 = (NodeItem)e.getSecondNode();
                int maxE = Math.max(n1.getEdgeCount(),n2.getEdgeCount());
                if ( maxE <= 80 )
                    return normal;
                else if ( maxE <= 180 )
                    return slack1;
                else
                    return slack2;
            } //
        };
d430 1
d432 1
a432 1
                new Action[] {bcolorFunc, ccolorFunc}, 0);
d434 2
a435 7
        actionMap = new ActionMap();
        actionMap.put("filter", feyeFilter);
        actionMap.put("browseColors", bcolorFunc);
        actionMap.put("compareColors", ccolorFunc);
        actionMap.put("colorSwitch", colorSwitch);
        actionMap.put("dynamicForces", fdLayout);
        actionMap.put("staticForces", frLayout);
d437 3
a439 2
        // initialize basic recoloring-drawing action list
        redraw = new ActionList(registry, 0);
d441 1
d444 28
d475 5
d482 24
a505 1
        // initilaize the forces action list
d527 1
d531 15
a545 1
        altAnimate.add(new RepaintAction());
d547 1
a547 2
        // initialize focus listeners
        FocusSet defaultSet = registry.getDefaultFocusSet();
d550 6
a555 3
                // unfix previous center item
                NodeItem n = registry.getNodeItem((Node)e.getFirstRemoved());
                if ( n != null ) n.setFixed(false);
d557 8
a564 1
                centerDisplay(); // center display on the new focus
d567 15
a581 2
                if ( useDatabase )
                    loader.loadNeighbors((Node)e.getFirstAdded());
d591 5
a595 1
                profile.updatePanel(f);
d602 2
a603 1
                redraw();
d628 1
a628 1
        return fsim;
d635 1
d638 2
d642 6
a647 2
        searcher.setBackground(bg);
        searcher.setForeground(fg);
d650 13
a662 1
        renderers.setBrowseMode(b);
d665 2
a666 2
    public ComparisonColorFunction getComparisonColorFunction() {
        return (ComparisonColorFunction)actionMap.get("compareColors");
d669 2
a670 2
    public BrowsingColorFunction getBrowsingColorFunction() {
        return (BrowsingColorFunction)actionMap.get("browseColors");
d695 55
@


1.8
log
@Major updates for static layout and xml input files
@
text
@a21 1
import vizster.util.SearchPanel;
d24 1
d40 3
d50 1
a50 3
import edu.berkeley.guir.prefuse.util.DefaultFocusSet;
import edu.berkeley.guir.prefuse.util.FocusSet;
import edu.berkeley.guir.prefuse.util.KeywordSearchFocusSet;
d101 1
a101 1
    private SearchPanel searcher;
d158 1
a158 1
        final KeywordSearchFocusSet searchSet = new KeywordSearchFocusSet();
d182 2
a183 1
        searcher = new SearchPanel(this);
d356 3
a358 1
            protected float getSpringLength(NodeItem n1, NodeItem n2) {
d363 3
a365 1
            protected float getSpringCoefficient(NodeItem n1, NodeItem n2) {
@


1.7
log
@Added additional, no-argument constructor
@
text
@d33 2
d37 1
d43 1
d60 1
d72 2
a73 1
    private static final String DEFAULT_START_UID = "186297";
d86 1
a86 1
    private ActionList forces, filter;
d88 2
d94 3
d112 4
a115 2
        String startUID = argv.length > 0 ? argv[0] : DEFAULT_START_UID;
        new Vizster(startUID);
d122 1
a122 1
        this(DEFAULT_START_UID);
d127 1
a127 1
     * @@param startUID the friendster user id to show first
d130 10
d142 6
a147 3
        // initialize empty graph and registry
        Graph g = new DefaultGraph();
        registry = new ItemRegistry(g);
d150 2
a151 2
        // -We already get a default focus set, use it for centered nodes
        // -Add another set for nodes that are clicked, to show profiles
d153 1
d160 13
a172 11
        // create a new loader to talk to the database
        loader = new VizsterDBLoader(registry, VizsterDBLoader.ALL_COLUMNS);
        // register update listener with graph loader
        loader.addGraphLoaderListener(new GraphLoaderListener() {
            public void entityLoaded(GraphLoader loader, Entity e) {
                filter.runNow();
            } //
            public void entityUnloaded(GraphLoader loader, Entity e) {
                filter.runNow();
            } //
        });
a185 19
        // attempt to login to database
        if ( !VizsterLib.authenticate(this, loginRetries) ) {
            System.exit(0); // user canceled login so exit
        }
        
        // load the initial profile from the database
        Node r = null;
        try {
            r = loader.getProfileNode(startUID);
        } catch ( SQLException e ) {
            e.printStackTrace();
            VizsterLib.profileLoadError(this, startUID);
            System.exit(1);
        }
        // add initial node to the graph, and set as focus
        g.addNode(r);
        registry.getDefaultFocusSet().set(r);
        fmanager.getFocusSet(CLICK_KEY).set(r);
        
d190 3
a192 3
        display.addControlListener(new NeighborHighlightControl());
        display.addControlListener(new DragControl(false, true));
        display.addControlListener(new PanControl(false));
d195 1
a195 1
        ZoomControl zc = new ZoomControl(false);
d206 38
d245 32
a276 1
        forces.runNow();
d337 7
d348 22
d378 2
d381 4
a384 6
        // initialize the force simulator
        fsim = new ForceSimulator();
        fsim.addForce(new NBodyForce(-1.5f, -1f, 0.9f));
        final SpringForce springF = new SpringForce(2E-5f, 150f);
        fsim.addForce(springF);
        fsim.addForce(new DragForce(-0.005f));
d405 12
a416 21
        forces.add(new ForceDirectedLayout(fsim, false, false) {
            private float normal = 2E-5f;
            private float slack1 = 2E-6f;
            private float slack2 = 2E-7f;
            protected float getSpringLength(NodeItem n1, NodeItem n2) {
                int minE = Math.min(n1.getEdgeCount(),n2.getEdgeCount());
                double doi = Math.max(n1.getDOI(), n2.getDOI());
                return ( minE == 1 ? 75.f : (doi==0? 200.f : 100.f));
            } //
            protected float getSpringCoefficient(NodeItem n1, NodeItem n2) {
                int maxE = Math.max(n1.getEdgeCount(),n2.getEdgeCount());
                if ( maxE <= 80 )
                    return normal;
                else if ( maxE <= 180 )
                    return slack1;
                else
                    return slack2;
            } //
        });
        forces.add(colorSwitch);
        forces.add(new RepaintAction());
d428 3
a430 1
                loader.loadNeighbors((Node)e.getFirstAdded());
d443 7
d498 22
@


1.6
log
@Vizster 1.0
@
text
@d107 7
@


1.5
log
@Vizster 1.0
@
text
@d348 4
@


1.4
log
@New DB loader
@
text
@d4 1
d18 2
a19 1
import vizster.color.*;
d29 3
d74 4
d84 1
d248 1
d252 11
a262 2
        FisheyeGraphFilter   feyeFilter = new FisheyeGraphFilter(-1);
        BrowsingColorFunction colorFunc = new BrowsingColorFunction();
d274 1
a274 1
        filter.add(colorFunc);
d293 1
a293 1
            private float slack2 = 5E-7f;
d309 1
a309 1
        forces.add(colorFunc);
d356 23
@


1.3
log
@update
@
text
@d72 1
a72 1
    private VizsterDatabaseLoader loader;
d117 1
a117 2
        loader = new VizsterDatabaseLoader(registry,
                VizsterDatabaseLoader.ALL_COLUMNS);
d141 1
a141 1
        if ( !VizsterLib.authenticate(this, loader, loginRetries) ) {
d302 1
d328 1
a328 1
    public VizsterDatabaseLoader getLoader() {
@


1.2
log
@Vizster update
@
text
@a255 12
        filter.add(new AbstractAction() {
            private float normal = 2E-5f;
            private float slack  = 2E-6f;
            public void run(ItemRegistry registry, double frac) {
                int sz = registry.size(ItemRegistry.DEFAULT_NODE_CLASS);
                if ( sz > 100 ) {
                    springF.setParameter(SpringForce.SPRING_COEFF, slack);
                } else {
                    springF.setParameter(SpringForce.SPRING_COEFF, normal);
                }
            } //
        });
d272 3
d276 1
a276 2
                if (n1.getEdgeCount() == 1 || n2.getEdgeCount() == 1)
                    return 75.f;
d278 10
a287 1
                return 200.f/Math.abs((float)doi-1);
@


1.1
log
@Initial commit
@
text
@d17 1
d74 1
d132 1
a132 1
        display.setSize(700,700);
d200 1
a200 1
        scroller.setPreferredSize(new Dimension(285,pd.height));
a207 6
//        JSplitPane split1 = new JSplitPane(JSplitPane.VERTICAL_SPLIT,
//                false, display, searcher);
//        split1.setDividerSize(10);
//        split1.setResizeWeight(1.0);
//        split1.setOneTouchExpandable(true);
        
d243 8
a250 1
        VizsterColorFunction colorFunc = new VizsterColorFunction();
d256 12
a267 6
        
        // initialize the force simulator
        ForceSimulator fsim = new ForceSimulator();
        fsim.addForce(new NBodyForce(-1.5f, -1f, 0.9f));
        fsim.addForce(new SpringForce(2E-5f, 150f));
        fsim.addForce(new DragForce(-0.005f));
d333 4
@

